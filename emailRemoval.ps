# Target Gmail account to remove
$targetEmail = "haydonlord9@gmail.com"

Write-Host "=== Removing account: $targetEmail ===`n"

function Remove-IfMatch {
    param([string]$Path,[string]$Why)
    try {
        $props = Get-ItemProperty -LiteralPath $Path -ErrorAction Stop
        $allText = ($props.PSObject.Properties.Value -join "`n")
        $allText += "`n" + (Split-Path -Leaf $Path)
        if ($allText -match [regex]::Escape($targetEmail)) {
            Remove-Item -LiteralPath $Path -Recurse -Force -ErrorAction Stop
            Write-Host "[REMOVED] $($Why):`n  $Path`n"
        }
    } catch {}
}

# 1) IdentityCRL: StoredIdentities
$stored = "HKCU:\Software\Microsoft\IdentityCRL\StoredIdentities"
if (Test-Path $stored) {
    # direct hit if the key is named like the email
    $direct = Join-Path $stored $targetEmail
    if (Test-Path $direct) { Remove-Item -LiteralPath $direct -Recurse -Force -ErrorAction SilentlyContinue; Write-Host "[REMOVED] StoredIdentities:`n  $direct`n" }
    Get-ChildItem -LiteralPath $stored | ForEach-Object { Remove-IfMatch $_.PsPath "IdentityCRL\StoredIdentities" }
}

# 2) IdentityCRL: UserExtendedProperties
$uxp = "HKCU:\Software\Microsoft\IdentityCRL\UserExtendedProperties"
if (Test-Path $uxp) {
    Get-ChildItem -LiteralPath $uxp | ForEach-Object { Remove-IfMatch $_.PsPath "IdentityCRL\UserExtendedProperties" }
}

# 3) Web Account Manager (WAM)
$wam = "HKCU:\Software\Microsoft\Windows\CurrentVersion\WebAccountManager\Accounts"
if (Test-Path $wam) {
    Get-ChildItem -LiteralPath $wam | ForEach-Object { Remove-IfMatch $_.PsPath "WAM Account" }
}

# 4) Credential Manager cleanup
$targets = (cmdkey /list) 2>$null
if ($targets) {
    $targets -split "`r?`n" |
      Where-Object { $_ -match '^\s*Target:' } |
      ForEach-Object {
        $t = ($_ -replace '^\s*Target:\s*','').Trim()
        if ($t -like "*$targetEmail*") {
            cmdkey /delete:$t | Out-Null
            Write-Host "[REMOVED] Credential: $t"
        }
      }
}

Write-Host "`nDone. Opening Settings so you can check..."
Start-Process "ms-settings:emailandaccounts"
Start-Process "ms-settings:workplace"

$ans = Read-Host "Restart now to finalize? (Y/N)"
if ($ans -match '^[Yy]') { Restart-Computer -Force }
